function [Pr_IAPWS,F,G,phi0,phir,dphir] = IAPWS(rho,T)
% Parameters
rho_c = 322; % kg/m3
Tc    = 647.096; % K
R     = 0.46151805; % kJ/kg/K
n0    = [-8.3204464837497  6.6832105275932 3.00632 0.012436   0.97315    1.27950    0.96956    0.24873   ];
gam0  = [nan               nan             nan     1.28728967 3.53734222 7.74073708 9.24437796 27.5075105];
eq6_pars = [
    1             nan            1             -0.5              0.12533547935523e-1 0 0 0 0 0 0 0 0 0 0
    2             nan            1            0.875              0.78957634722828e1 0 0 0 0 0 0 0 0 0 0
    3             nan            1               1              -0.87803203303561e1 0 0 0 0 0 0 0 0 0 0
    4             nan            2              0.5              0.31802509345418 0 0 0 0 0 0 0 0 0 0
    5             nan            2             0.75             -0.26145533859358 0 0 0 0 0 0 0 0 0 0
    6             nan            3            0.375             -0.78199751687981e-2 0 0 0 0 0 0 0 0 0 0
    7             nan            4               1               0.88089493102134e-2 0 0 0 0 0 0 0 0 0 0
    8             1              1               4              -0.66856572307965 0 0 0 0 0 0 0 0 0 0
    9             1              1               6               0.20433810950965 0 0 0 0 0 0 0 0 0 0
    10            1              1              12              -0.66212605039687e-4 0 0 0 0 0 0 0 0 0 0
    11            1              2               1              -0.19232721156002 0 0 0 0 0 0 0 0 0 0
    12            1              2               5              -0.25709043003438 0 0 0 0 0 0 0 0 0 0
    13            1              3               4               0.16074868486251 0 0 0 0 0 0 0 0 0 0
    14            1              4               2              -0.40092828925807e-1 0 0 0 0 0 0 0 0 0 0
    15            1              4              13               0.39343422603254e-6 0 0 0 0 0 0 0 0 0 0
    16            1              5               9              -0.75941377088144e-5 0 0 0 0 0 0 0 0 0 0
    17            1              7               3               0.56250979351888e-3 0 0 0 0 0 0 0 0 0 0
    18            1              9               4              -0.15608652257135e-4 0 0 0 0 0 0 0 0 0 0
    19            1             10             11                0.11537996422951e-8 0 0 0 0 0 0 0 0 0 0
    20            1             11              4                0.36582165144204e-6 0 0 0 0 0 0 0 0 0 0
    21            1             13             13               -0.13251180074668e-11 0 0 0 0 0 0 0 0 0 0
    22            1             15              1               -0.62639586912454e-9 0 0 0 0 0 0 0 0 0 0
    23            2              1               7              -0.10793600908932 0 0 0 0 0 0 0 0 0 0
    24            2              2               1               0.17611491008752e-1 0 0 0 0 0 0 0 0 0 0
    25            2              2               9               0.22132295167546 0 0 0 0 0 0 0 0 0 0
    26            2              2              10              -0.40247669763528 0 0 0 0 0 0 0 0 0 0
    27            2              3              10               0.58083399985759 0 0 0 0 0 0 0 0 0 0
    28            2              4               3               0.49969146990806e-2 0 0 0 0 0 0 0 0 0 0
    29            2              4               7              -0.31358700712549e-1 0 0 0 0 0 0 0 0 0 0
    30            2              4              10              -0.74315929710341 0 0 0 0 0 0 0 0 0 0
    31            2              5              10               0.47807329915480 0 0 0 0 0 0 0 0 0 0
    32            2              6               6               0.20527940895948e-1 0 0 0 0 0 0 0 0 0 0
    33            2              6              10              -0.13636435110343 0 0 0 0 0 0 0 0 0 0
    34            2              7              10               0.14180634400617e-1 0 0 0 0 0 0 0 0 0 0
    35            2              9               1               0.83326504880713e-2 0 0 0 0 0 0 0 0 0 0
    36            2              9               2              -0.29052336009585e-1 0 0 0 0 0 0 0 0 0 0
    37            2              9               3               0.38615085574206e-1 0 0 0 0 0 0 0 0 0 0
    38            2              9               4              -0.20393486513704e-1 0 0 0 0 0 0 0 0 0 0
    39            2              9               8              -0.16554050063734e-2 0 0 0 0 0 0 0 0 0 0
    40            2             10              6                0.19955571979541e-2 0 0 0 0 0 0 0 0 0 0
    41            2             10              9                0.15870308324157e-3 0 0 0 0 0 0 0 0 0 0
    42            2             12              8               -0.16388568342530e-4 0 0 0 0 0 0 0 0 0 0
    43            3              3              16               0.43613615723811e-1 0 0 0 0 0 0 0 0 0 0
    44            3              4              22               0.34994005463765e-1 0 0 0 0 0 0 0 0 0 0
    45            3              4              23              -0.76788197844621e-1 0 0 0 0 0 0 0 0 0 0
    46            3              5              23               0.22446277332006e-1 0 0 0 0 0 0 0 0 0 0
    47            4             14             10               -0.62689710414685e-4 0 0 0 0 0 0 0 0 0 0
    48            6              3              50              -0.55711118565645e-9 0 0 0 0 0 0 0 0 0 0
    49            6              6              44              -0.19905718354408 0 0 0 0 0 0 0 0 0 0
    50            6              6              46               0.31777497330738 0 0 0 0 0 0 0 0 0 0
    51            6              6               50             -0.11841182425981 0 0 0 0 0 0 0 0 0 0
    52            nan            3               0              -0.31306260323435e2 20 150 1.21 1 0 0 0 0 0 0
    53            nan            3               1               0.31546140237781e2 20 150 1.21 1 0 0 0 0 0 0
    54            nan            3               4              -0.25213154341695e4 20 250 1.25 1 0 0 0 0 0 0
    55            0              0               0              -0.14874640856724   0  0.3   0  0 3.5 0.85 0.2 28 700 0.32
    56            0              0               0               0.31806110878444   0  0.3   0  0 3.5 0.95 0.2 32 800 0.32
    ];
c = eq6_pars(:,2);
d = eq6_pars(:,3);
t = eq6_pars(:,4);
n = eq6_pars(:,5);
alph  = eq6_pars(:,6);
betaa = eq6_pars(:,7);
gam  = eq6_pars(:,8);
epsi = eq6_pars(:,9);
a  = eq6_pars(:,10);
b  = eq6_pars(:,11);
B  = eq6_pars(:,12);
C  = eq6_pars(:,13);
D  = eq6_pars(:,14);
A  = eq6_pars(:,15);
% Preprocess
deltaa = rho/rho_c;
tau   = Tc./T;
% Initialize
phi0  = 0;
phir  = 0;
dphir = 0;
% The ideal part of Helmholtz energy
for i = 4:8
    phi0  = phi0 + n0(i)*log(1-exp(-gam0(i)*tau));
end
phi0 = phi0 + log(deltaa) + n0(1) + n0(2)*tau + n0(3)*log(tau);
% The residual part
for i = 1:7
    phir  = phir + n(i)*deltaa.^d(i).*tau.^t(i);
    dphir = dphir + n(i)*d(i)*deltaa.^(d(i)-1).*(tau.^t(i));
end
for i = 8:51
    phir  = phir  + n(i)*deltaa.^d(i).*tau.^t(i).*exp(-deltaa.^c(i));
    dphir = dphir + n(i)*exp(-deltaa.^c(i)).*(deltaa.^(d(i)-1).*(tau.^t(i)).*(d(i)-c(i).*deltaa.^c(i)));
end
for i = 52:54
    phir   = phir  + n(i)*deltaa.^d(i).*tau.^t(i).*exp(-alph(i).*(deltaa-epsi(i)).^2-betaa(i)*(tau-gam(i)).^2);
    dphir  = dphir + n(i)*deltaa.^d(i).*tau.^t(i).*exp(-alph(i).*(deltaa-epsi(i)).^2-betaa(i)*(tau-gam(i)).^2) ...
        .*(d(i)./deltaa-2*alph(i)*(deltaa-epsi(i)));
end
for i = 55:56
    theta = (1-tau) + A(i)*((deltaa-1).^2).^(1/(2*betaa(i)));
    delta_L = theta.^2+B(i)*((deltaa-1).^2).^a(i);
    psi = exp(-C(i)*(deltaa-1).^2-D(i)*(tau-1).^2);
    phir   = phir + n(i)*delta_L.^b(i).*deltaa.*psi;
    dpsi_d = -2*C(i)*(deltaa-1).*psi;
    d_D_dd = (deltaa-1).*(A(i).*theta*2/betaa(i).*((deltaa-1).^2).^(1/(2*betaa(i))-1) + 2*B(i)*a(i)*((deltaa-1).^2).^(a(i)-1) );
    d_Dbi_d = b(i)*delta_L.^(b(i)-1).*d_D_dd;
    dphir  = dphir + n(i)*( delta_L.^b(i).*(psi + deltaa.*dpsi_d) + d_Dbi_d.*deltaa.*psi);
end
F = (phi0 + phir)*R*1e3.*T;
G = (1 + phi0 + phir + deltaa.*dphir)*R*1e3.*T;
% Pressure
Pr_IAPWS    = (1 + deltaa.*dphir).*rho*R*1e3.*T/1e6;
end