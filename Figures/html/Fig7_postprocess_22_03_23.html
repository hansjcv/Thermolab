
<!DOCTYPE html
  PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head>
      <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
   <!--
This HTML was auto-generated from MATLAB code.
To make changes, update the MATLAB code and republish this document.
      --><title>Fig7_postprocess_22_03_23</title><meta name="generator" content="MATLAB 9.7"><link rel="schema.DC" href="http://purl.org/dc/elements/1.1/"><meta name="DC.date" content="2022-03-23"><meta name="DC.source" content="Fig7_postprocess_22_03_23.m"><style type="text/css">
html,body,div,span,applet,object,iframe,h1,h2,h3,h4,h5,h6,p,blockquote,pre,a,abbr,acronym,address,big,cite,code,del,dfn,em,font,img,ins,kbd,q,s,samp,small,strike,strong,sub,sup,tt,var,b,u,i,center,dl,dt,dd,ol,ul,li,fieldset,form,label,legend,table,caption,tbody,tfoot,thead,tr,th,td{margin:0;padding:0;border:0;outline:0;font-size:100%;vertical-align:baseline;background:transparent}body{line-height:1}ol,ul{list-style:none}blockquote,q{quotes:none}blockquote:before,blockquote:after,q:before,q:after{content:'';content:none}:focus{outine:0}ins{text-decoration:none}del{text-decoration:line-through}table{border-collapse:collapse;border-spacing:0}

html { min-height:100%; margin-bottom:1px; }
html body { height:100%; margin:0px; font-family:Arial, Helvetica, sans-serif; font-size:10px; color:#000; line-height:140%; background:#fff none; overflow-y:scroll; }
html body td { vertical-align:top; text-align:left; }

h1 { padding:0px; margin:0px 0px 25px; font-family:Arial, Helvetica, sans-serif; font-size:1.5em; color:#d55000; line-height:100%; font-weight:normal; }
h2 { padding:0px; margin:0px 0px 8px; font-family:Arial, Helvetica, sans-serif; font-size:1.2em; color:#000; font-weight:bold; line-height:140%; border-bottom:1px solid #d6d4d4; display:block; }
h3 { padding:0px; margin:0px 0px 5px; font-family:Arial, Helvetica, sans-serif; font-size:1.1em; color:#000; font-weight:bold; line-height:140%; }

a { color:#005fce; text-decoration:none; }
a:hover { color:#005fce; text-decoration:underline; }
a:visited { color:#004aa0; text-decoration:none; }

p { padding:0px; margin:0px 0px 20px; }
img { padding:0px; margin:0px 0px 20px; border:none; }
p img, pre img, tt img, li img, h1 img, h2 img { margin-bottom:0px; } 

ul { padding:0px; margin:0px 0px 20px 23px; list-style:square; }
ul li { padding:0px; margin:0px 0px 7px 0px; }
ul li ul { padding:5px 0px 0px; margin:0px 0px 7px 23px; }
ul li ol li { list-style:decimal; }
ol { padding:0px; margin:0px 0px 20px 0px; list-style:decimal; }
ol li { padding:0px; margin:0px 0px 7px 23px; list-style-type:decimal; }
ol li ol { padding:5px 0px 0px; margin:0px 0px 7px 0px; }
ol li ol li { list-style-type:lower-alpha; }
ol li ul { padding-top:7px; }
ol li ul li { list-style:square; }

.content { font-size:1.2em; line-height:140%; padding: 20px; }

pre, code { font-size:12px; }
tt { font-size: 1.2em; }
pre { margin:0px 0px 20px; }
pre.codeinput { padding:10px; border:1px solid #d3d3d3; background:#f7f7f7; }
pre.codeoutput { padding:10px 11px; margin:0px 0px 20px; color:#4c4c4c; }
pre.error { color:red; }

@media print { pre.codeinput, pre.codeoutput { word-wrap:break-word; width:100%; } }

span.keyword { color:#0000FF }
span.comment { color:#228B22 }
span.string { color:#A020F0 }
span.untermstring { color:#B20000 }
span.syscmd { color:#B28C00 }

.footer { width:auto; padding:10px 0px; margin:25px 0px 0px; border-top:1px dotted #878787; font-size:0.8em; line-height:140%; font-style:italic; color:#878787; text-align:left; float:none; }
.footer p { margin:0px; }
.footer a { color:#878787; }
.footer a:hover { color:#878787; text-decoration:underline; }
.footer a:visited { color:#878787; }

table th { padding:7px 5px; text-align:left; vertical-align:middle; border: 1px solid #d6d4d4; font-weight:bold; }
table td { padding:7px 5px; text-align:left; vertical-align:top; border:1px solid #d6d4d4; }





  </style></head><body><div class="content"><pre class="codeinput">clear,addpath <span class="string">../</span>
runname = <span class="string">'example_soap'</span>;
load([runname <span class="string">'_linprog'</span>]);                                              <span class="comment">% load linprog run data</span>
molm = molmass_fun(Cname);                                               <span class="comment">% get molar mass of the components</span>
<span class="comment">% Numerics</span>
delP     = 1e5;                                                          <span class="comment">% for numerical differentiation</span>
delc     = 1e-5;                                                         <span class="comment">% for numerical differentiation</span>
solv_tol = 2;                                                            <span class="comment">% Tolerance for recognizing exsolved phases</span>
<span class="comment">% Cluster analysis to find exsolved phases</span>
[alph,Nphs,p_out,pc_id] = cluster_p(alph,Npc,p,pc_id,solv_tol,phases);    <span class="comment">% Compute exsolved, or numerically equivalent phases</span>
<span class="comment">% For numerical derivatives</span>
rho_w         = rho_H2O(T,P,<span class="string">'ZD05'</span>);                  <span class="comment">% Calculate density of water</span>
eps_w         = eps_H2O(T,P,rho_w,<span class="string">'S14'</span>);             <span class="comment">% Calculate dielectric constant of water</span>
rho_w_dP      = rho_H2O(T,P+delP,<span class="string">'ZD05'</span>);             <span class="comment">% Calculate density of water at P + dP</span>
eps_w_dP      = eps_H2O(T,P+delP,rho_w_dP,<span class="string">'S14'</span>);     <span class="comment">% Calculate dielectric constant of water at P + dP</span>
[g0,v0]       = tl_g0(T,P,td,rho_w,eps_w);            <span class="comment">% Calculate endmember Gibbs energies of each solution</span>
[g0_dP,v0_dP] = tl_g0(T,P+delP,td,rho_w_dP,eps_w_dP); <span class="comment">% Calculate endmember Gibbs energies of each solution at dP</span>
g             = tl_gibbs_energy(T,P     ,phases,td,p_out,g0,v0,rho_w,eps_w);            <span class="comment">% get Gibbs energy at P</span>
g_P           = tl_gibbs_energy(T,P+delP,phases,td,p_out,g0_dP,v0_dP,rho_w_dP,eps_w_dP);<span class="comment">% get Gibbs energy at P+dP</span>
<span class="comment">% Postprocessing</span>
Vmol     = (g_P-g)/delP;                                                     <span class="comment">% Equation 54</span>
Mmol     = Nphs'*molm;                                                       <span class="comment">% Equation 56</span>
rho      = Mmol./Vmol;                                                       <span class="comment">% Equation 57</span>
phim     = alph/sum(alph);                                                   <span class="comment">% Equation 52</span>
phi      = phim.*Vmol./(Vmol'*phim);                                         <span class="comment">% Equation 53</span>
phiw     = phim.*Mmol./(Mmol'*phim);                                         <span class="comment">% Equation 55</span>
Cwt      = Nphs.*repmat(molm,1,size(Nphs,2))./repmat(Mmol',size(Nphs,1),1);  <span class="comment">% Equation 58</span>
fluid_id =  strcmp(phases(pc_id),fluid);                                     <span class="comment">% Find index of fluid</span>
solid_id = ~fluid_id;                                                        <span class="comment">% Find index of solids</span>
rhos     = rho(solid_id)'*phi(solid_id)/sum(phi(solid_id));                  <span class="comment">% Equation 59</span>
rhof     = rho(fluid_id)'*phi(fluid_id)/sum(phi(fluid_id));                  <span class="comment">% Fluid density</span>
<span class="comment">% Chemical potentials</span>
<span class="keyword">for</span> iphase = 1:numel(g)
    Gphase  = g(iphase);
    mu_last = Gphase;
    nc      = sum(p_out{pc_id(iphase)}&gt;0);
    <span class="keyword">if</span> nc &gt; 1
        <span class="keyword">for</span> ic = 1:nc-1
            c_ind                        = find(p_out{pc_id(iphase)}&gt;0);
            p1                           = p_out;
            p1{pc_id(iphase)}(c_ind(ic)) = p_out{pc_id(iphase)}(c_ind(ic)) + delc;
            p1{pc_id(iphase)}(c_ind(nc)) = p_out{pc_id(iphase)}(c_ind(nc)) - delc;
            g_dc                         = tl_gibbs_energy(T,P,phases,td,p1,g0,v0,rho_w,eps_w);
            Gphase1                      = g_dc(iphase);
            dGdc1                        = (Gphase1-Gphase)/delc;
            mu_last                      = mu_last - p_out{pc_id(iphase)}(c_ind(ic)).*dGdc1; <span class="comment">% Equation 60</span>
            mu{iphase}(ic)               = dGdc1;
        <span class="keyword">end</span>
        <span class="keyword">for</span> ic = 1:nc-1
            mu{iphase}(ic) = mu{iphase}(ic) + mu_last;                                       <span class="comment">% Equation 61</span>
        <span class="keyword">end</span>
    <span class="keyword">end</span>
    mu{iphase}(nc) = mu_last;
    chk_mu(iphase) = mu{iphase}*p_out{pc_id(iphase)}(c_ind)'-g(iphase);  <span class="comment">% Check that g = sum(mu*p)</span>
<span class="keyword">end</span>
<span class="comment">% Display some results</span>
disp(phases(pc_id))                                                      <span class="comment">% Display stable phase assemblage</span>
disp(phi')                                                               <span class="comment">% Display volume fraction</span>
disp(Cwt)                                                                <span class="comment">% Display phase composition</span>
disp(rhos)                                                               <span class="comment">% Display solid density</span>
disp(max(abs(chk_mu)))                                                   <span class="comment">% Check consistency of chemical potential and g</span>
</pre><p class="footer"><br><a href="https://www.mathworks.com/products/matlab/">Published with MATLAB&reg; R2019b</a><br></p></div><!--
##### SOURCE BEGIN #####
clear,addpath ../
runname = 'example_soap';
load([runname '_linprog']);                                              % load linprog run data
molm = molmass_fun(Cname);                                               % get molar mass of the components
% Numerics
delP     = 1e5;                                                          % for numerical differentiation
delc     = 1e-5;                                                         % for numerical differentiation
solv_tol = 2;                                                            % Tolerance for recognizing exsolved phases
% Cluster analysis to find exsolved phases
[alph,Nphs,p_out,pc_id] = cluster_p(alph,Npc,p,pc_id,solv_tol,phases);    % Compute exsolved, or numerically equivalent phases 
% For numerical derivatives
rho_w         = rho_H2O(T,P,'ZD05');                  % Calculate density of water
eps_w         = eps_H2O(T,P,rho_w,'S14');             % Calculate dielectric constant of water
rho_w_dP      = rho_H2O(T,P+delP,'ZD05');             % Calculate density of water at P + dP
eps_w_dP      = eps_H2O(T,P+delP,rho_w_dP,'S14');     % Calculate dielectric constant of water at P + dP
[g0,v0]       = tl_g0(T,P,td,rho_w,eps_w);            % Calculate endmember Gibbs energies of each solution
[g0_dP,v0_dP] = tl_g0(T,P+delP,td,rho_w_dP,eps_w_dP); % Calculate endmember Gibbs energies of each solution at dP
g             = tl_gibbs_energy(T,P     ,phases,td,p_out,g0,v0,rho_w,eps_w);            % get Gibbs energy at P
g_P           = tl_gibbs_energy(T,P+delP,phases,td,p_out,g0_dP,v0_dP,rho_w_dP,eps_w_dP);% get Gibbs energy at P+dP
% Postprocessing
Vmol     = (g_P-g)/delP;                                                     % Equation 54
Mmol     = Nphs'*molm;                                                       % Equation 56
rho      = Mmol./Vmol;                                                       % Equation 57
phim     = alph/sum(alph);                                                   % Equation 52
phi      = phim.*Vmol./(Vmol'*phim);                                         % Equation 53
phiw     = phim.*Mmol./(Mmol'*phim);                                         % Equation 55
Cwt      = Nphs.*repmat(molm,1,size(Nphs,2))./repmat(Mmol',size(Nphs,1),1);  % Equation 58
fluid_id =  strcmp(phases(pc_id),fluid);                                     % Find index of fluid
solid_id = ~fluid_id;                                                        % Find index of solids
rhos     = rho(solid_id)'*phi(solid_id)/sum(phi(solid_id));                  % Equation 59
rhof     = rho(fluid_id)'*phi(fluid_id)/sum(phi(fluid_id));                  % Fluid density
% Chemical potentials
for iphase = 1:numel(g)
    Gphase  = g(iphase);
    mu_last = Gphase;
    nc      = sum(p_out{pc_id(iphase)}>0);
    if nc > 1         
        for ic = 1:nc-1
            c_ind                        = find(p_out{pc_id(iphase)}>0);
            p1                           = p_out;
            p1{pc_id(iphase)}(c_ind(ic)) = p_out{pc_id(iphase)}(c_ind(ic)) + delc;
            p1{pc_id(iphase)}(c_ind(nc)) = p_out{pc_id(iphase)}(c_ind(nc)) - delc;
            g_dc                         = tl_gibbs_energy(T,P,phases,td,p1,g0,v0,rho_w,eps_w);
            Gphase1                      = g_dc(iphase);
            dGdc1                        = (Gphase1-Gphase)/delc;
            mu_last                      = mu_last - p_out{pc_id(iphase)}(c_ind(ic)).*dGdc1; % Equation 60
            mu{iphase}(ic)               = dGdc1;
        end
        for ic = 1:nc-1
            mu{iphase}(ic) = mu{iphase}(ic) + mu_last;                                       % Equation 61
        end
    end
    mu{iphase}(nc) = mu_last;        
    chk_mu(iphase) = mu{iphase}*p_out{pc_id(iphase)}(c_ind)'-g(iphase);  % Check that g = sum(mu*p)
end
% Display some results
disp(phases(pc_id))                                                      % Display stable phase assemblage
disp(phi')                                                               % Display volume fraction
disp(Cwt)                                                                % Display phase composition
disp(rhos)                                                               % Display solid density
disp(max(abs(chk_mu)))                                                   % Check consistency of chemical potential and g
##### SOURCE END #####
--></body></html>